{% extends "base.html" %}

{% block title %}Изменить пароль - PatternCraft Lab{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/change-passwors.css') }}" />
{% endblock %}

{% block content %}
  <h2>Изменить пароль</h2>
  <form id="change-password-form" novalidate method="POST" action="{{ url_for('users.change_password') }}">
    {{ form.hidden_tag() }}
    <div class="form-group">
      <label for="current-password">Текущий пароль</label>
      <div class="password-field-container">
        {{ form.current_password(id="current-password") }}
        <button type="button" class="password-toggle" aria-label="Показать пароль">
          <i class="fas fa-eye"></i>
        </button>
      </div>
    </div>

    <div class="form-group" id="new-password-container">
      <label for="new-password">Новый пароль</label>
      <div class="password-field-container">
        {{ form.new_password(id="new-password", oninput="checkPasswordStrength(this.value)") }}
        <button type="button" class="password-toggle" aria-label="Показать пароль">
          <i class="fas fa-eye"></i>
        </button>
      </div>
      
      <div class="password-strength-meter">
        <div class="strength-bar" id="strength-bar"></div>
      </div>
      <div class="password-strength-info" id="password-strength-info"></div>
      
      <div class="password-rules-card">
        <div class="rules-header">
          <i class="fas fa-shield-alt"></i>
          <h4>Требования к паролю</h4>
        </div>
        <ul class="rules-list">
          <li class="rule-item" data-rule="length">
            <span class="rule-icon"><i class="fas fa-circle"></i></span>
            <span class="rule-text">Минимум 6 символов</span>
          </li>
          <li class="rule-item" data-rule="uppercase">
            <span class="rule-icon"><i class="fas fa-circle"></i></span>
            <span class="rule-text">Хотя бы одна заглавная буква</span>
          </li>
          <li class="rule-item" data-rule="number">
            <span class="rule-icon"><i class="fas fa-circle"></i></span>
            <span class="rule-text">Хотя бы одна цифра</span>
          </li>
          <li class="rule-item" data-rule="special">
            <span class="rule-icon"><i class="fas fa-circle"></i></span>
            <span class="rule-text">Хотя бы один спецсимвол</span>
          </li>
        </ul>
      </div>
    </div>

    <div class="form-group">
      <label for="confirm-password">Подтвердите новый пароль</label>
      <div class="password-field-container">
        {{ form.confirm_password(id="confirm-password") }}
        <button type="button" class="password-toggle" aria-label="Показать пароль">
          <i class="fas fa-eye"></i>
        </button>
      </div>
    </div>

    <button type="submit" class="btn"><i class="fas fa-key"></i> Сменить пароль</button>
  </form>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    function checkPasswordStrength(password) {
      const strengthBar = document.getElementById('strength-bar');
      const strengthInfo = document.getElementById('password-strength-info');
      const ruleItems = document.querySelectorAll('.rule-item');
      
      const rules = {
        length: password.length >= 6,
        uppercase: /[A-Z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[^A-Za-z0-9]/.test(password)
      };
      
      ruleItems.forEach(item => {
        const rule = item.dataset.rule;
        if (rules[rule]) {
          item.classList.add('valid');
        } else {
          item.classList.remove('valid');
        }
      });
      
      const strength = Object.values(rules).filter(Boolean).length;
      const strengthPercent = (strength / 4) * 100;
      
      strengthBar.style.width = `${strengthPercent}%`;
      
      if (strengthPercent < 40) {
        strengthBar.style.background = 'var(--password-weak)';
        strengthInfo.textContent = 'Слабый пароль';
        strengthInfo.style.color = 'var(--password-weak)';
      } else if (strengthPercent < 70) {
        strengthBar.style.background = 'var(--password-medium)';
        strengthInfo.textContent = 'Средний пароль';
        strengthInfo.style.color = 'var(--password-medium)';
      } else {
        strengthBar.style.background = 'var(--password-strong)';
        strengthInfo.textContent = 'Сильный пароль!';
        strengthInfo.style.color = 'var(--password-strong)';
      }
    }

    document.querySelectorAll('.password-toggle').forEach(button => {
      button.addEventListener('click', function() {
        const input = this.parentElement.querySelector('input');
        const icon = this.querySelector('i');
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.replace('fa-eye', 'fa-eye-slash');
          this.setAttribute('aria-label', 'Скрыть пароль');
        } else {
          input.type = 'password';
          icon.classList.replace('fa-eye-slash', 'fa-eye');
          this.setAttribute('aria-label', 'Показать пароль');
        }
      });
    });
  </script>
{% endblock %}