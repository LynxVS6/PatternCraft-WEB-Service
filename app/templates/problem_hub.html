{% extends "base.html" %}

{% block content %}
<div class="filters-sidebar">
    <div class="filters-panel">
        <form class="filters-form" id="search_form">
            <div class="search-input-container">
                <input 
                    type="text" 
                    id="search_input" 
                    name="q" 
                    class="form-control search-input"
                    placeholder="{{ _('solved_problems_search_placeholder') }}"
                    aria-label="{{ _('solved_problems_search_label') }}"
                    value="{{ current_filters.search if current_filters else '' }}"
                >
                <button 
                    type="button" 
                    class="search-icon-btn" 
                    id="search"
                    aria-label="{{ _('solved_problems_search_button') }}"
                >
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div class="select-container">
                <label for="order_by">{{ _('solved_problems_sort_by') }}</label>
                <select id="order_by" name="order_by" class="form-control filter-select">
                    <option value="sort_date desc" {% if current_filters and current_filters.order_by == 'sort_date desc' %}selected{% endif %}>
                        {{ _('solved_problems_sort_newest') }}
                    </option>
                    <option value="sort_date asc" {% if current_filters and current_filters.order_by == 'published_at asc' %}selected{% endif %}>
                        {{ _('solved_problems_sort_oldest') }}
                    </option>
                    <option value="popularity desc" {% if current_filters and current_filters.order_by == 'popularity desc' %}selected{% endif %}>
                        {{ _('solved_problems_sort_popular') }}
                    </option>
                    <option value="satisfaction_percent desc,total_completed desc" 
                        {% if current_filters and current_filters.order_by == 'satisfaction_percent desc,total_completed desc' %}selected{% endif %}>
                        {{ _('solved_problems_sort_high_rating') }}
                    </option>
                    <option value="satisfaction_percent asc" {% if current_filters and current_filters.order_by == 'satisfaction_percent asc' %}selected{% endif %}>
                        {{ _('solved_problems_sort_low_rating') }}
                    </option>
                    <option value="name asc" {% if current_filters and current_filters.order_by == 'name asc' %}selected{% endif %}>
                        {{ _('solved_problems_sort_name') }}
                    </option>
                </select>
            </div>

            <div class="select-container">
                <label for="language_filter">{{ _('solved_problems_languages') }}</label>
                <select id="language_filter" name="language" class="form-control filter-select">
                    <option value="all" {% if current_filters and (not current_filters.language or current_filters.language == 'all') %}selected{% endif %}>
                        {{ _('solved_problems_all_languages') }}
                    </option>
                    <option value="my-languages" {% if current_filters and current_filters.language == 'my-languages' %}selected{% endif %}>
                        {{ _('solved_problems_selected_languages') }}
                    </option>
                    {% for lang in languages %}
                    <option value="{{ lang.code }}" {% if current_filters and current_filters.language == lang.code %}selected{% endif %}>
                        {{ lang.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="select-container">
                <label for="status_filter">{{ _('solved_problems_status') }}</label>
                <select id="status_filter" name="status" class="form-control filter-select">
                    <option value="all" {% if current_filters and (not current_filters.status or current_filters.status == 'all') %}selected{% endif %}>
                        {{ _('solved_problems_all') }}
                    </option>
                    <option value="verified" {% if current_filters and current_filters.status == 'verified' %}selected{% endif %}>
                        {{ _('solved_problems_verified') }}
                    </option>
                    <option value="beta" {% if current_filters and current_filters.status == 'beta' %}selected{% endif %}>
                        {{ _('solved_problems_beta') }}
                    </option>
                </select>
            </div>

            <div class="select-container">
                <label for="ids_filter">{{ _('solved_problems_progress') }}</label>
                <select id="ids_filter" name="xids" class="form-control filter-select">
                    <option value="all" {% if current_filters and (not current_filters.progress or current_filters.progress == 'all') %}selected{% endif %}>
                        {{ _('solved_problems_all') }}
                    </option>
                    <option value="completed" {% if current_filters and current_filters.progress == 'completed' %}selected{% endif %}>
                        {{ _('solved_problems_completed') }}
                    </option>
                    <option value="not_completed" {% if current_filters and current_filters.progress == 'not_completed' %}selected{% endif %}>
                        {{ _('solved_problems_not_completed') }}
                    </option>
                </select>
            </div>

            <div class="select-container">
                <label for="ranks_filter">{{ _('solved_problems_difficulty') }}</label>
                <select id="ranks_filter" name="r" class="form-control filter-select">
                    <option value="all" {% if current_filters and (not current_filters.difficulties or current_filters.difficulties == ['all']) %}selected{% endif %}>
                        {{ _('solved_problems_all') }}
                    </option>
                    <option value="easy" {% if current_filters and current_filters.difficulties == ['easy'] %}selected{% endif %}>
                        {{ _('solved_problems_easy') }}
                    </option>
                    <option value="medium" {% if current_filters and current_filters.difficulties == ['middle'] %}selected{% endif %}>
                        {{ _('solved_problems_medium') }}
                    </option>
                    <option value="hard" {% if current_filters and current_filters.difficulties == ['hard'] %}selected{% endif %}>
                        {{ _('solved_problems_hard') }}
                    </option>
                </select>
            </div>

            <div class="select-container">
                <label for="tags_filter">{{ _('solved_problems_tags') }}</label>
                <select id="tags_filter" name="tags" class="form-control filter-select" multiple>
                    {% for tag in tags %}
                    <option value="{{ tag.name }}" {% if tag.selected %}selected{% endif %}>
                        {{ tag.name }} ({{ tag.count }})
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

<div class="problems">
    <div class="problems-list">
        {% for problem in problems %}
        <div class="problem-card" data-id="{{ problem.id }}">
            <div class="problem-content">
                <div class="problem-main">
                    <div class="problem-header">
                        <div class="problem-title">
                            <div class="problem-difficulty">
                                <div class="difficulty-badge {{ problem.difficulty|lower }}">
                                    <span>{{ problem.difficulty }}</span>
                                </div>
                            </div>
                            <h3>{{ problem.name }}</h3>
                            <div class="language-icon">
                                <i class="devicon-{{ problem.language_icon }}-plain"></i>
                                <span>{{ problem.language }}</span>
                            </div>
                        </div>
                        <div class="problem-stats">
                            <span class="stat-item">
                                <i class="fas fa-star" aria-hidden="true"></i>
                                <span class="bookmark-count" data-problem-id="{{ problem.id }}">
                                    {{ problem.bookmark_count }}
                                </span>
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-chart-line" aria-hidden="true"></i>
                                <span class="vote-text" data-translation-key="solved_problems_votes">
                                    {{ problem.satisfaction_percent }}% {{ _('solved_problems_votes') }} {{ problem.total_votes }}
                                </span>
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-bullseye" aria-hidden="true"></i>
                                <span>{{ problem.completed_count }}</span>
                            </span>
                            <span class="stat-item">
                                <i class="fas fa-user" aria-hidden="true"></i>
                                <span>{{ problem.author }}</span>
                            </span>
                        </div>
                        <div class="problem-tags">
                            <i class="fas fa-tag" aria-hidden="true"></i>
                            {% for tag in problem.tags %}
                            <div class="tag">
                                <a href="?tags={{ tag }}">{{ tag }}</a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if pagination.total_pages > 1 %}
    <div class="pagination">
        {% if pagination.page > 1 %}
        <a href="?{{ dict(request.args, page=pagination.page-1)|urlencode }}" class="page-link">
            <i class="fas fa-chevron-left"></i> {{ _('pagination.previous') }}
        </a>
        {% endif %}

        {% set start_page = [min_page, pagination.page-2]|max %}
        {% set end_page = [max_page+1, pagination.page+3]|min %}
        {% for p in range(start_page, end_page) %}
        <a href="?{{ dict(request.args, page=p)|urlencode }}" 
        class="page-link {% if p == pagination.page %}active{% endif %}">
            {{ p }}
        </a>
        {% endfor %}

        {% if pagination.page < pagination.total_pages %}
        <a href="?{{ dict(request.args, page=pagination.page+1)|urlencode }}" class="page-link">
            {{ _('pagination.next') }} <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    // Define translations
    const translations = {
        'stats.votes': '{{ _("stats.votes") }}',
        'solved_problems_votes': '{{ _("solved_problems_votes") }}'
    };
    
    // Define translation function
    function _(key) {
        return translations[key] || key;
    }

    // Function to update vote text
    function updateVoteText(element, satisfactionPercent, totalVotes) {
        const translationKey = element.dataset.translationKey;
        element.textContent = `${satisfactionPercent}% ${_(translationKey)} ${totalVotes}`;
    }
</script>

<script src="{{ url_for('static', filename='js/problem_hub.js') }}"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/problem-hub.css') }}">
{% endblock %}